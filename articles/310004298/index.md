---
confluence-id: '310004298'
date: '2020-09-08T01:19:08.000+02:00'
last_modified_at: '2020-09-08T01:19:08.000+02:00'
layout: article
orig-title: How to set up AirPrint, AirPlay, Mopria, CUPS etc with mDNS,DNS-SD,Bonjour,Avahi,Zeroconf
  discovery over multicast in transparent mode
orig-title-slugified: how-to-set-up-airprint-airplay-mopria-cups-etc-with-mdns-dns-sd-bonjour-avahi-zeroconf-discovery-over-multicast-in-transparent-mode
permalink: /kb/310004298/#!how-to-set-up-airprint-airplay-mopria-cups-etc-with-mdns-dns-sd-bonjour-avahi-zeroconf-discovery-over-multicast-in-transparent-mode
published: 'true'
slug: '310004298'
tags: kb kbcore kbhowto kbmdns kbmulticast kbtransparentmode kbairprint kbigmp
title: How to set up AirPrint, AirPlay, Mopria, CUPS etc with mDNS,DNS-SD,Bonjour,Avahi,Zeroconf
  discovery over multicast in transparent mode
version: 32
---

<ac:layout><ac:layout-section ac:type="two_equal"><ac:layout-cell><ac:structured-macro ac:name="excerpt" ac:schema-version="1" ac:macro-id="2a6e168f-b284-4015-a70f-5110bdc4ede8"><ac:parameter ac:name="atlassian-macro-output-type">INLINE</ac:parameter><ac:rich-text-body><p>As with all mDNS-based discovery, transparent mode and multicast forwarding (multiplex SAT) rules are required. 224.0.0.251 multicasts to port 5353 have to be forwarded in both directions. And, of course, the printing itself: IPP, TCP port 631.</p></ac:rich-text-body></ac:structured-macro><ac:structured-macro ac:name="note" ac:schema-version="1" ac:macro-id="aea36fbe-63b9-4f4f-bbcd-64470260feae"><ac:rich-text-body><p><strong>This NOT YET TESTED with an actual iThing, only with a Linux client + Mopria!</strong></p></ac:rich-text-body></ac:structured-macro><p><br /></p><p><ac:structured-macro ac:name="toc" ac:schema-version="1" ac:macro-id="b14ec6bf-c24f-4c52-ae96-1779f5f720df" /></p><br /><p><br /></p></ac:layout-cell><ac:layout-cell><ac:structured-macro ac:name="details" ac:schema-version="1" ac:macro-id="d6c80c04-42e9-45c0-8446-1df87ed8ca22"><ac:rich-text-body><table class="wrapped"><colgroup> <col /> <col /> </colgroup><tbody><tr><td><p>Up to date for</p></td><td><p>Core 12.00.21</p><p>Core 13.00.00</p><p>Mopria Print Service for Android 2.10.6</p><p>CUPS (2019)</p></td></tr><tr><td colspan="1">Supported since</td><td colspan="1">Core 8.70.xx</td></tr><tr><td colspan="1">Not valid for</td><td colspan="1"><ac:placeholder>Remove line if unnecessary </ac:placeholder></td></tr><tr><td colspan="1">Status</td><td colspan="1"><div class="content-wrapper"><p>&nbsp;<ac:structured-macro ac:name="status" ac:schema-version="1" ac:macro-id="000e7e8f-43e7-42ba-90a3-a0bc34ddfd27"><ac:parameter ac:name="colour">Green</ac:parameter><ac:parameter ac:name="title">OK</ac:parameter></ac:structured-macro>&nbsp;</p></div></td></tr></tbody></table></ac:rich-text-body></ac:structured-macro></ac:layout-cell></ac:layout-section><ac:layout-section ac:type="single"><ac:layout-cell><h1>mDNS? Bonjour? AirSomething?</h1><ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="aef4ae9c-dd23-42cf-b81f-9697529467eb"><ac:rich-text-body><p><ac:emoticon ac:name="information" /> More specifically,&nbsp;<a href="http://www.dns-sd.org/">DNS-SD</a> <em>typically</em> runs on top of mDNS, but technically speaking it can query a regular DNS server, too, if the server is configured to hand out these records. But that's unusual.</p></ac:rich-text-body></ac:structured-macro><p>First, it's important to understand that these are all (mostly) about UDP multicasts to address 224.0.0.251, port 5353. Aka &quot;multicast DNS&quot;, mDNS.</p><p>Example mDNS query from a Linux host running &quot;mdns-scan&quot;:</p><p><ac:image ac:queryparams="effects=border-simple,blur-border"><ri:attachment ri:filename="example-query.png" /></ac:image></p><p>Example mDNS response from a multifunction printer/scanner:</p><p><ac:image ac:queryparams="effects=border-simple,blur-border"><ri:attachment ri:filename="example-response.png" /></ac:image></p><p><br /></p><h1>Strategy - IGMP or not?</h1><ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="a296df52-0004-495e-832b-b01eb2fa27a4"><ac:rich-text-body><p><ac:emoticon ac:name="information" /> IGMP makes more sense for large data streams, where you want to limit the amount of traffic flowing. Here, you always want to receive the mDNS packets.</p></ac:rich-text-body></ac:structured-macro><p>We can opt to work with IGMP Rules (under the Routing subsection), which also works, but <em>assumes</em> that all units speak IGMP correctly.</p><p>It would also mean delays in our testing - <em>nothing would work until the firewall receives the IGMP rebroadcasts</em>.</p><p>So, we opt to simply go for raw <strong>SAT Multiplex</strong> rules: <strong>Always forward the multicasts,</strong> regardless of hearing IGMP or not.</p><p><br /></p><h1>How to configure</h1><h2>Enable transparent mode</h2><p>First, <strong>Transparent Mode</strong> most likely needs to be enabled on the involved interfaces.</p><p>-- Without it, TTL=1 multicasts will be dropped. (But if all systems use higher TTLs it will likely still work? Untested.)</p><p>Note that &quot;Forward Broadcast Traffic&quot; does <em>not</em> need to be enabled on the interfaces for this to work. mDNS uses multicast, not broadcast.</p><h2>But I don't want switched routes, L3C, CAM, and all of that?</h2><p>That's fine. Simply configure static routes. It's just that Transparent Mode on the sending interface is currently a requirement for leaving the IP TTL untouched in cOS Core.</p><p>With static routes + Transparent Mode, the only 2 differences will be:</p><ul><li>MAC addresses are not hidden</li><li>We can leave the IP TTL alone</li></ul><h2>Add Multiplex SAT rules for mDNS in both directions</h2><ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="a21d8a07-3724-44d8-8428-64e22f0506b8"><ac:rich-text-body><p><ac:emoticon ac:name="question" /> <em>Can you use interface groups to make it a single rule?</em></p><p>Yes, it'll work, but unfortunately the firewall <u>will also duplicate the packet back</u> out the interface it came from, which is <u>possibly dangerous</u> if there is another unit doing the same.</p></ac:rich-text-body></ac:structured-macro><p>As you see in the packet traces, mDNS responses do not arrive to the IP address that sent the query. They are sent out to the multicast address.</p><p>Therefore, mDNS multicasts have to be separately <strong>allowed in both directions</strong>.</p><p><ac:image ac:queryparams="effects=border-simple,blur-border"><ri:attachment ri:filename="sat-multiplex-rule.png" /></ac:image></p><p>... and of course <strong>one more in the opposite direction</strong>.</p><ac:task-list>
<ac:task>
<ac:task-id>1</ac:task-id>
<ac:task-status>incomplete</ac:task-status>
<ac:task-body><span>Make RFE about interface groups in sat multiplex - don't send back out where it came from!</span></ac:task-body>
</ac:task>
</ac:task-list><ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="53c86b68-e0d9-417b-930b-af8b1405e93f"><ac:rich-text-body><p><span><ac:emoticon ac:name="information" /> Technically, the firewall defaults to adding a route for 224.0.0.0/4 to &quot;core&quot; so you <em>could</em> also set the destination interface to &quot;core&quot;. </span></p></ac:rich-text-body></ac:structured-macro><p><span>Note the &quot;Destination: any&quot; in the filter - it does not make sense to filter according to the routing table here.</span></p><p><span><br /></span></p><h2>Add rule for Internet Printing Protocol</h2><p>This is entirely straightforward.</p><p>Allow traffic to the printer's IP address, TCP port 631.</p><p><br /></p><h2>Double check TTL setting</h2><p>In case a unit sends mDNS packets with IP TTL=1, we may want to make sure we don't decrement it to 0 and drop it.</p><p>There may also be mDNS clients that check for TTL still being 255 on receipt, i.e. that the packet didn't traverse a network boundary.</p><p>Either way, it's a good idea to make sure that TTL is left untouched:</p><p><ac:image ac:queryparams="effects=border-simple,blur-border" ac:height="250"><ri:attachment ri:filename="decrement-ttl-off.png" /></ac:image></p><h3>That's a lot of talk about TTL?</h3><p>Well, <a href="https://tools.ietf.org/html/rfc6762">https://tools.ietf.org/html/rfc6762</a> says this:</p><pre>11. Source Address Check</pre><pre>   All Multicast DNS responses (including responses sent via unicast)
   SHOULD be sent with IP TTL set to 255.  This is recommended to
   provide backwards-compatibility with older Multicast DNS queriers
   (implementing a draft version of this document, posted in February
   2004) that check the IP TTL on reception to determine whether the
   packet originated on the local link.  These older queriers discard
   all packets with TTLs other than 255.
</pre><p>And additionally, there are recommendations for dropping mDNS packets if the source IP address does not belong on the local network.</p><p><ac:emoticon ac:name="warning" /> If you find an mDNS that implementation refuses to cross the firewall boundary, you may have to renumber your IP ranges to match.</p><p>Microsoft's mDNS implementation for instance, <em>may</em> give you problems via Windows Defender Firewall. But here you can simply re-configure the rules.</p><p><ac:image ac:queryparams="effects=border-simple,blur-border" ac:width="800"><ri:attachment ri:filename="image2019-10-23_12-9-27.png" /></ac:image></p><h2>Test it!</h2><p><ac:image ac:queryparams="effects=border-simple,blur-border"><ri:attachment ri:filename="mdns-scan-console-screenshot.png" /></ac:image></p><p><br /></p><p><br /></p></ac:layout-cell></ac:layout-section><ac:layout-section ac:type="single"><ac:layout-cell><h1>Related articles</h1><p><ac:structured-macro ac:name="contentbylabel" ac:schema-version="3" ac:macro-id="4b7092f5-2a8e-4add-a850-4932891af740"><ac:parameter ac:name="sort">modified</ac:parameter><ac:parameter ac:name="excerptType">rich content</ac:parameter><ac:parameter ac:name="cql">label in (&quot;kbmulticast&quot;,&quot;kbairprint&quot;,&quot;kbmdns&quot;,&quot;kbtransparentmode&quot;,&quot;kbigmp&quot;,&quot;kbprint&quot;) and type = &quot;page&quot;</ac:parameter></ac:structured-macro></p><p><ac:placeholder> Change the labels in the macro to match suitably narrow labels, e.g. &quot;kbdhcp, kbrouting&quot; but not &quot;kbcore&quot;/&quot;kbhowto&quot;/&quot;kb&quot;/&quot;kbdictionary&quot;. Pages with ANY of the labels will be shown - it's _not_ a &quot;must match all&quot; filter. (You can of course use as much advanced filtering as you like!) </ac:placeholder></p><p><br /></p><p><br /></p></ac:layout-cell></ac:layout-section></ac:layout>